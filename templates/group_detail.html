<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ group.name }}</title>
    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        .group-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
        }
        .group-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 15px;
            border: 4px solid white;
            object-fit: cover;
        }
        .group-actions {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .member-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        .post-form {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-btn {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .tab-btn:hover {
            background: #f8f9fa;
        }
        .tab-btn.active {
            border-bottom: 2px solid #007bff;
            color: #007bff;
            font-weight: bold;
        }
        .request-pending {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .post-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .edit-mode {
            background: #fff3cd;
            border: 1px solid #ffc107;
        }
        .edit-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
            resize: vertical;
            font-family: inherit;
            font-size: 14px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–µ–¥–∏–∞ */
        .media-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .media-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        .media-preview-item img,
        .media-preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .remove-media-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–¥–∏–∞ –≤ –ø–æ—Å—Ç–µ */
        .post-media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .media-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        .media-item img,
        .media-item video {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        .video-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
        .media-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .media-viewer img,
        .media-viewer video {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }
        .media-viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: black;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞—è–≤–æ–∫ */
        .request-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }
        .request-badge {
            background: #dc3545;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div style="padding: 20px; max-width: 800px; margin: 0 auto;">
        <div style="margin-bottom: 20px;">
            <a href="/groups" style="margin-right: 10px;">‚Üê –ì—Ä—É–ø–ø—ã</a>
            <a href="/home">–ì–ª–∞–≤–Ω–∞—è</a>
        </div>

        <div class="group-header">
            <div style="display: flex; align-items: center; gap: 20px;">
                <img src="{{ url_for('static', filename='uploads/groups/' + group.avatar) if group.avatar else 'https://via.placeholder.com/120?text=Group' }}"
                     class="group-avatar-large"
                     onerror="this.src='https://via.placeholder.com/120?text=Group'">

                <div>
                    <h1 style="margin: 0 0 10px 0;">{{ group.name }}</h1>
                    <p style="margin: 0 0 10px 0; opacity: 0.9;">{{ group.description or '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è' }}</p>
                    <div style="display: flex; gap: 15px; font-size: 14px;">
                        <span>üë• {{ group.members_count }} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                        <span>üìù {{ group.posts_count }} –ø–æ—Å—Ç–æ–≤</span>
                        <span>üìÖ –°–æ–∑–¥–∞–Ω {{ group.created_at[:10]|replace('-', '.') }}</span>
                    </div>
                    {% if not group.is_public %}
                    <div style="margin-top: 10px; font-size: 14px; opacity: 0.9;">
                        üîí –ü—Ä–∏–≤–∞—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="group-actions">
                {% if role == 'admin' %}
                <a href="/group/{{ group.id }}/settings"
                   style="background: white; color: #333; padding: 10px 15px; border-radius: 5px; text-decoration: none; margin-right: 10px;">
                    –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </a>
                {% endif %}

                {% if is_member %}
                    <form method="POST" action="/leave_group/{{ group.id }}" style="display: inline;"
                            onsubmit="return confirmLeaveGroup({{ 'true' if group.creator_id == session_user_id else 'false' }}, '{{ group.name }}')">
                        <button type="submit"
                            style="background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                        –û—Ç–ø–∏—Å–∞—Ç—å—Å—è
                        </button>
                    </form>
                {% else %}
                    {% if has_pending_request %}
                    <div class="request-pending">
                        ‚è≥ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞
                    </div>
                    {% else %}
                    <form method="POST" action="/join_group/{{ group.id }}" style="display: inline;">
                        <button type="submit" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            {% if group.is_public %}–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è{% else %}–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É{% endif %}
                        </button>
                    </form>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div style="display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px;">
            <div class="tab-btn active" onclick="switchTab('posts')">
                –ü–æ—Å—Ç—ã
            </div>
            <div class="tab-btn" onclick="switchTab('members')">
                –£—á–∞—Å—Ç–Ω–∏–∫–∏
            </div>
            <div class="tab-btn" onclick="switchTab('about')">
                –û –ø–∞–±–ª–∏–∫–µ
            </div>
            {% if show_requests_tab %}
            <div class="tab-btn" onclick="switchTab('requests')">
                –ó–∞—è–≤–∫–∏
                {% if pending_requests_count > 0 %}
                <span style="background: #dc3545; color: white; border-radius: 10px; padding: 2px 6px; font-size: 12px;">
                    {{ pending_requests_count }}
                </span>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–∫–∏ "–ü–æ—Å—Ç—ã" -->
        <div id="tab-posts" class="tab-content active">
            <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞ -->
            {% if is_member and can_post %}
            <div class="post-form">
                <h3>–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</h3>
                <form method="POST" action="/group/{{ group.id }}/create_post" enctype="multipart/form-data" id="create-post-form">
                    <textarea name="content" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤ –≥—Ä—É–ø–ø–µ?"
                              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; height: 100px;"></textarea>

                    <!-- –ü–æ–ª–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
                    <div style="margin-top: 15px; margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                            üìé –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ
                        </label>
                        <input type="file" name="media_files" id="media-files"
                               accept="image/*,video/*" multiple
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <p style="margin-top: 5px; color: #666; font-size: 12px;">
                            –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ 10 —Ñ–∞–π–ª–æ–≤. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50MB –Ω–∞ —Ñ–∞–π–ª
                        </p>

                        <!-- –ü—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
                        <div id="media-preview" class="media-preview-container">
                            <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –ø—Ä–µ–≤—å—é —Ñ–∞–π–ª–æ–≤ -->
                        </div>
                    </div>

                    <button type="submit" style="margin-top: 10px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px;">
                        –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                    </button>
                </form>
            </div>
            {% elif is_member and not can_post %}
            <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <p style="margin: 0; color: #856404;">
                    <strong>
                        {% if group.post_permissions == 'admins' %}
                            –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Å—Ç—ã –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ.
                        {% elif group.post_permissions == 'moderators' %}
                            –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Å—Ç—ã –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ.
                        {% else %}
                            –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤ –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ.
                        {% endif %}
                    </strong>
                </p>
            </div>
            {% endif %}

            {% if posts %}
                {% for post in posts %}
                <div id="post-{{ post.id }}" class="post-container {% if post.is_editing %}edit-mode{% endif %}" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <img src="{{ url_for('static', filename='uploads/avatars/' + post.author_avatar) if post.author_avatar else 'https://via.placeholder.com/30?text=Avatar' }}"
                             style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;"
                             onerror="this.src='https://via.placeholder.com/30?text=Avatar'">
                        <div style="flex: 1;">
                            <div>
                                <strong>{{ post.author_name or post.author_username }}</strong>
                                {% if post.author_role == 'admin' %}
                                <span style="font-size: 10px; color: #dc3545; margin-left: 5px;">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                                {% elif post.author_role == 'moderator' %}
                                <span style="font-size: 10px; color: #17a2b8; margin-left: 5px;">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</span>
                                {% else %}
                                <span style="font-size: 10px; color: #6c757d; margin-left: 5px;">–£—á–∞—Å—Ç–Ω–∏–∫</span>
                                {% endif %}
                                <div style="font-size: 12px; color: #666;">{{ datetime_format(post.created_at) }}</div>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤ -->
                        {% set can_edit_post = false %}
                        {% set can_delete_post = false %}

                        <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ -->
                        {% if post.author_id == session_user_id %}
                            <!-- –ê–≤—Ç–æ—Ä –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–¥–∞–ª—è—Ç—å —Å–≤–æ–π –ø–æ—Å—Ç -->
                            {% set can_edit_post = true %}
                            {% set can_delete_post = true %}
                        {% elif role == 'admin' %}
                            <!-- –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–¥–∞–ª—è—Ç—å –ª—é–±—ã–µ –ø–æ—Å—Ç—ã -->
                            {% set can_edit_post = true %}
                            {% set can_delete_post = true %}
                        {% elif role == 'moderator' %}
                            <!-- –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç—ã –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                            {% if post.author_role == 'member' %}
                                {% set can_edit_post = true %}
                                {% set can_delete_post = true %}
                            {% endif %}
                        {% endif %}

                        {% if can_edit_post or can_delete_post %}
                        <div class="post-actions">
                            {% if can_edit_post %}
                            <button onclick="editPost({{ post.id }})" style="background: none; border: none; color: #007bff; cursor: pointer; padding: 5px;" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                ‚úèÔ∏è
                            </button>
                            {% endif %}

                            {% if can_delete_post %}
                            <button onclick="deleteGroupPost({{ post.id }})" style="background: none; border: none; color: #dc3545; cursor: pointer; padding: 5px;" title="–£–¥–∞–ª–∏—Ç—å">
                                üóëÔ∏è
                            </button>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    {% if post.is_editing %}
                    <textarea id="edit-content-{{ post.id }}" class="edit-textarea">{{ post.content }}</textarea>
                    <div style="margin-top: 10px;">
                        <button onclick="saveEdit({{ post.id }})" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; margin-right: 10px;">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <button onclick="cancelEdit({{ post.id }})" style="padding: 8px 15px; background: #6c757d; color: white; border: none; border-radius: 4px;">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                    {% else %}
                    <p id="post-content-{{ post.id }}" style="margin: 10px 0; white-space: pre-wrap;">{{ post.content }}</p>

                    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ -->
                    {% if post.media_files %}
                    <div class="post-media-grid">
                        {% for media in post.media_files %}
                            <div class="media-item" onclick="openMediaViewer('{{ url_for('static', filename='uploads/posts/' + media.filename) }}', '{{ media.file_type }}')">
                                {% if media.file_type == 'image' %}
                                <img src="{{ url_for('static', filename='uploads/posts/' + media.filename) }}"
                                     onerror="this.src='https://via.placeholder.com/200x200?text=–û—à–∏–±–∫–∞+–∑–∞–≥—Ä—É–∑–∫–∏'">
                                {% elif media.file_type == 'video' %}
                                <video>
                                    <source src="{{ url_for('static', filename='uploads/posts/' + media.filename) }}">
                                </video>
                                <div class="video-icon">‚ñ∂Ô∏è –í–ò–î–ï–û</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                        <button onclick="likeGroupPost({{ post.id }})" style="background: none; border: none; color: #666; cursor: pointer; padding: 5px 10px;">
                            üëç {{ post.likes_count or 0 }}
                        </button>
                        <button onclick="commentOnPost({{ post.id }})" style="background: none; border: none; color: #666; cursor: pointer; padding: 5px 10px;">
                            üí¨ –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
            <div style="text-align: center; padding: 40px; color: #666;">
                <h3>–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤</h3>
                <p>
                    {% if is_member %}
                        {% if can_post %}
                            –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ø–æ—Å—Ç!
                        {% else %}
                            –í —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤.
                        {% endif %}
                    {% else %}
                        –í—Å—Ç—É–ø–∏—Ç–µ –≤ –ø–∞–±–ª–∏–∫, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –ø–æ—Å—Ç—ã
                    {% endif %}
                </p>
            </div>
            {% endif %}
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–∫–∏ "–£—á–∞—Å—Ç–Ω–∏–∫–∏" -->
        <div id="tab-members" class="tab-content">
            <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏ ({{ members|length }})</h3>
            <div class="member-list">
                {% for member in members %}
                <div style="text-align: center; min-width: 80px;">
                    <a href="/profile/{{ member.id }}" style="text-decoration: none; color: inherit;">
                        <img src="{{ url_for('static', filename='uploads/avatars/' + member.avatar) if member.avatar else 'https://via.placeholder.com/40?text=Avatar' }}"
                            class="member-avatar"
                            onerror="this.src='https://via.placeholder.com/40?text=Avatar'">
                        <div style="font-size: 12px; margin-top: 5px; word-break: break-word;">
                            {{ member.username }}
                        </div>
                        {% if member.role == 'admin' %}
                        <div style="font-size: 10px; color: #dc3545; margin-top: 2px;">–ê–¥–º–∏–Ω</div>
                        {% elif member.role == 'moderator' %}
                        <div style="font-size: 10px; color: #17a2b8; margin-top: 2px;">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</div>
                        {% endif %}
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–∫–∏ "–û –ø–∞–±–ª–∏–∫–µ" -->
        <div id="tab-about" class="tab-content">
            <h3>–û –ø–∞–±–ª–∏–∫–µ</h3>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                <p><strong>–°–æ–∑–¥–∞—Ç–µ–ª—å:</strong>
                    <a href="/profile/{{ creator.id }}" style="color: #007bff; text-decoration: none;">
                        {{ creator.full_name or creator.username }}
                    </a>
                </p>
                <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> {{ group.created_at[:10]|replace('-', '.') }}</p>
                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ '–ü—É–±–ª–∏—á–Ω—ã–π' if group.is_public else '–ü—Ä–∏–≤–∞—Ç–Ω—ã–π (—Ç–æ–ª—å–∫–æ –ø–æ –∑–∞—è–≤–∫–µ)' }}</p>
                <p><strong>–ü—É–±–ª–∏–∫–∞—Ü–∏–∏:</strong>
                    {% if group.post_permissions == 'admins' %}
                        –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã
                    {% elif group.post_permissions == 'moderators' %}
                        –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã
                    {% else %}
                        –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏
                    {% endif %}
                </p>
                {% if group.description %}
                <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong><br>{{ group.description }}</p>
                {% endif %}
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–∫–∏ "–ó–∞—è–≤–∫–∏" -->
        {% if show_requests_tab %}
        <div id="tab-requests" class="tab-content">
            <h3>–ó–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h3>

            {% if pending_requests %}
            <div class="requests-list">
                {% for request in pending_requests %}
                <div class="request-card">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <img src="{{ url_for('static', filename='uploads/avatars/' + request.avatar) if request.avatar else 'https://via.placeholder.com/50?text=Avatar' }}"
                             style="width: 50px; height: 50px; border-radius: 50%; margin-right: 15px;"
                             onerror="this.src='https://via.placeholder.com/50?text=Avatar'">

                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0;">
                                {{ request.full_name or request.username }}
                            </h4>
                            <p style="margin: 0; color: #666;">@{{ request.username }}</p>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                –ü–æ–¥–∞–ª(–∞) –∑–∞—è–≤–∫—É: {{ datetime_format(request.created_at) }}
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button onclick="approveRequest({{ request.request_id }}, '{{ request.username }}')"
                                    style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                –ü—Ä–∏–Ω—è—Ç—å
                            </button>
                            <button onclick="rejectRequest({{ request.request_id }}, '{{ request.username }}')"
                                    style="padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 40px; color: #666;">
                <h4>–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞—è–≤–æ–∫</h4>
                <p>–í—Å–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã</p>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <script>
    document.getElementById('create-post-form').addEventListener('submit', function(e) {
        const content = this.querySelector('textarea[name="content"]').value.trim();
        const files = this.querySelector('#media-files').files;

        console.log('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:', content);
        console.log('–§–∞–π–ª—ã:', files.length);

        for (let i = 0; i < files.length; i++) {
            console.log(`–§–∞–π–ª ${i}:`, files[i].name, files[i].size, files[i].type);
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ
        if (!content && files.length === 0) {
            e.preventDefault();
            alert('–ü–æ—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –î–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–∞–π–ª—ã.');
            return false;
        }

        return true;
    });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –Ω–∞–∂–∞—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ
            event.target.classList.add('active');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ –≥—Ä—É–ø–ø—ã
        function confirmLeaveGroup(isCreator, groupName) {
            if (isCreator) {
                return confirm(`–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —è–≤–ª—è–µ—Ç–µ—Å—å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º –≥—Ä—É–ø–ø—ã "${groupName}".\n\n–ï—Å–ª–∏ –≤—ã –ø–æ–∫–∏–Ω–µ—Ç–µ –≥—Ä—É–ø–ø—É, –æ–Ω–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –£–î–ê–õ–ï–ù–ê –≤–º–µ—Å—Ç–µ —Å–æ –≤—Å–µ–º–∏ –ø–æ—Å—Ç–∞–º–∏ –∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏!\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?`);
            } else {
                return confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É "${groupName}"?`);
            }
        }

        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
        document.getElementById('media-files').addEventListener('change', function(e) {
            const previewContainer = document.getElementById('media-preview');
            previewContainer.innerHTML = '';

            const files = Array.from(this.files);

            files.forEach((file, index) => {
                const fileType = file.type.split('/')[0];
                const previewItem = document.createElement('div');
                previewItem.className = 'media-preview-item';

                if (fileType === 'image') {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    previewItem.appendChild(img);
                } else if (fileType === 'video') {
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.controls = false;
                    video.muted = true;
                    previewItem.appendChild(video);
                }

                // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-media-btn';
                removeBtn.innerHTML = '√ó';

                removeBtn.addEventListener('click', function() {
                    // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –∏–∑ input
                    const dt = new DataTransfer();
                    const filesArray = Array.from(document.getElementById('media-files').files);
                    filesArray.splice(index, 1);
                    filesArray.forEach(f => dt.items.add(f));
                    document.getElementById('media-files').files = dt.files;

                    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–≤—å—é
                    previewItem.remove();
                });

                previewItem.appendChild(removeBtn);
                previewContainer.appendChild(previewItem);
            });
        });

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞
        document.getElementById('create-post-form').addEventListener('submit', function(e) {
            const content = this.querySelector('textarea[name="content"]').value.trim();
            const files = this.querySelector('#media-files').files;

            if (!content && files.length === 0) {
                e.preventDefault();
                alert('–ü–æ—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –î–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–∞–π–ª—ã.');
                return false;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤ (–º–∞–∫—Å–∏–º—É–º 50MB)
            const maxSize = 50 * 1024 * 1024;
            for (let file of files) {
                if (file.size > maxSize) {
                    e.preventDefault();
                    alert(`–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50MB.`);
                    return false;
                }
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤ (–º–∞–∫—Å–∏–º—É–º 10)
            if (files.length > 10) {
                e.preventDefault();
                alert('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ 10 —Ñ–∞–π–ª–æ–≤ –∑–∞ —Ä–∞–∑.');
                return false;
            }

            return true;
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ –∏–∑ –≥—Ä—É–ø–ø—ã
        function deleteGroupPost(postId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) {
                fetch(`/group_post/delete/${postId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
                });
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞
        function editPost(postId) {
            const postContainer = document.getElementById(`post-${postId}`);
            const postContent = document.getElementById(`post-content-${postId}`);

            // –°–æ–∑–¥–∞–µ–º textarea –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const editTextarea = document.createElement('textarea');
            editTextarea.id = `edit-content-${postId}`;
            editTextarea.className = 'edit-textarea';
            editTextarea.value = postContent.textContent;

            // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const buttonContainer = document.createElement('div');
            buttonContainer.style.marginTop = '10px';

            const saveButton = document.createElement('button');
            saveButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            saveButton.style.padding = '8px 15px';
            saveButton.style.background = '#28a745';
            saveButton.style.color = 'white';
            saveButton.style.border = 'none';
            saveButton.style.borderRadius = '4px';
            saveButton.style.marginRight = '10px';
            saveButton.onclick = () => saveEdit(postId);

            const cancelButton = document.createElement('button');
            cancelButton.textContent = '–û—Ç–º–µ–Ω–∞';
            cancelButton.style.padding = '8px 15px';
            cancelButton.style.background = '#6c757d';
            cancelButton.style.color = 'white';
            cancelButton.style.border = 'none';
            cancelButton.style.borderRadius = '4px';
            cancelButton.onclick = () => cancelEdit(postId);

            buttonContainer.appendChild(saveButton);
            buttonContainer.appendChild(cancelButton);

            // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –∫–Ω–æ–ø–∫–∏ –ª–∞–π–∫–æ–≤
            postContent.style.display = 'none';
            const actionsDiv = postContainer.querySelector('div[style*="border-top: 1px solid #eee"]');
            if (actionsDiv) actionsDiv.style.display = 'none';

            // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã –µ—Å–ª–∏ –µ—Å—Ç—å
            const mediaGrid = postContainer.querySelector('.post-media-grid');
            if (mediaGrid) mediaGrid.style.display = 'none';

            // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            postContainer.appendChild(editTextarea);
            postContainer.appendChild(buttonContainer);
            postContainer.classList.add('edit-mode');
        }

        function saveEdit(postId) {
            const editTextarea = document.getElementById(`edit-content-${postId}`);
            const newContent = editTextarea.value.trim();

            if (!newContent) {
                alert('–ü–æ—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }

            fetch(`/group_post/edit/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content: newContent })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ—Å—Ç–∞
                    const postContent = document.getElementById(`post-content-${postId}`);
                    postContent.textContent = newContent;

                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—ã–π –≤–∏–¥
                    cancelEdit(postId);
                    alert('–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
            });
        }

        function cancelEdit(postId) {
            const postContainer = document.getElementById(`post-${postId}`);
            const editTextarea = document.getElementById(`edit-content-${postId}`);
            const buttonContainer = editTextarea.nextElementSibling;

            // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            editTextarea.remove();
            buttonContainer.remove();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –∫–Ω–æ–ø–∫–∏ –ª–∞–π–∫–æ–≤
            const postContent = document.getElementById(`post-content-${postId}`);
            postContent.style.display = 'block';
            const actionsDiv = postContainer.querySelector('div[style*="border-top: 1px solid #eee"]');
            if (actionsDiv) actionsDiv.style.display = 'block';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã –µ—Å–ª–∏ –µ—Å—Ç—å
            const mediaGrid = postContainer.querySelector('.post-media-grid');
            if (mediaGrid) mediaGrid.style.display = 'grid';

            postContainer.classList.remove('edit-mode');
        }

        // –õ–∞–π–∫ –ø–æ—Å—Ç–∞
        function likeGroupPost(postId) {
            fetch(`/like_post/${postId}?type=group`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –ù–∞–π–¥–µ–º –∫–Ω–æ–ø–∫—É –ª–∞–π–∫–∞ –∏ –æ–±–Ω–æ–≤–∏–º —Å—á–µ—Ç—á–∏–∫
                    const buttons = document.querySelectorAll(`button[onclick="likeGroupPost(${postId})"]`);
                    buttons.forEach(btn => {
                        btn.innerHTML = `üëç ${data.likes_count}`;
                    });
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
            });
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ–¥–∏–∞ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
        function openMediaViewer(src, type) {
            const viewer = document.createElement('div');
            viewer.className = 'media-viewer';

            if (type === 'image') {
                const img = document.createElement('img');
                img.src = src;
                viewer.appendChild(img);
            } else if (type === 'video') {
                const video = document.createElement('video');
                video.src = src;
                video.controls = true;
                video.autoplay = true;
                video.style.maxWidth = '90%';
                video.style.maxHeight = '90%';
                viewer.appendChild(video);
            }

            const closeBtn = document.createElement('button');
            closeBtn.className = 'media-viewer-close';
            closeBtn.innerHTML = '√ó';
            closeBtn.onclick = function() {
                document.body.removeChild(viewer);
            };

            viewer.appendChild(closeBtn);
            viewer.onclick = function(e) {
                if (e.target === viewer) {
                    document.body.removeChild(viewer);
                }
            };

            document.body.appendChild(viewer);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–æ–∫
        function approveRequest(requestId, username) {
            if (confirm(`–ü—Ä–∏–Ω—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è @${username} –≤ –≥—Ä—É–ø–ø—É?`)) {
                fetch(`/group/{{ group.id }}/request/${requestId}/approve`, {
                    method: 'GET',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
                });
            }
        }

        function rejectRequest(requestId, username) {
            if (confirm(`–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è @${username}?`)) {
                fetch(`/group/{{ group.id }}/request/${requestId}/reject`, {
                    method: 'GET',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
                });
            }
        }

        function commentOnPost(postId) {
            alert('–§—É–Ω–∫—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ');
        }
    </script>
</body>
</html>