<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì—Ä—É–ø–ø—ã</title>
    <style>
        .group-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            background: white;
            transition: box-shadow 0.3s ease;
        }
        .group-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .group-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }
        .group-info {
            flex: 1;
        }
        .group-stats {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            color: #666;
            font-size: 14px;
        }
        .group-stats span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .create-group-btn {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .search-bar {
            margin-bottom: 20px;
        }
        .search-bar input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            text-decoration: none;
            color: #333;
            border-bottom: 2px solid transparent;
        }
        .tab:hover {
            background: #f8f9fa;
        }
        .tab.active {
            border-bottom: 2px solid #007bff;
            color: #007bff;
            font-weight: bold;
        }
        .group-actions {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 10px;
            min-width: 120px;
        }
        .subscribe-btn {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .subscribe-btn:hover {
            background: #218838;
        }
        .unsubscribe-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .unsubscribe-btn:hover {
            background: #c82333;
        }
        .invite-btn {
            padding: 8px 16px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .invite-btn:hover {
            background: #138496;
        }
        .invite-link-btn {
            padding: 8px 16px;
            background: #ffc107;
            color: #856404;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .invite-link-btn:hover {
            background: #e0a800;
        }
        .group-name {
            color: #007bff;
            text-decoration: none;
            font-size: 18px;
            font-weight: bold;
        }
        .group-name:hover {
            text-decoration: underline;
        }
        .role-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
            font-weight: normal;
        }
        .role-admin {
            background: #dc3545;
            color: white;
        }
        .role-moderator {
            background: #17a2b8;
            color: white;
        }
        .role-member {
            background: #6c757d;
            color: white;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è */
        .invite-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        .invite-modal.show {
            display: block;
        }
        .invite-modal-content {
            position: relative;
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .invite-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .invite-modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 22px;
        }
        .invite-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            transition: color 0.3s;
        }
        .invite-modal-close:hover {
            color: #dc3545;
        }
        .invite-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }
        .invite-tab {
            padding: 8px 16px;
            background: none;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.3s;
        }
        .invite-tab:hover {
            background: #e9ecef;
        }
        .invite-tab.active {
            background: #007bff;
            color: white;
        }
        .invite-section {
            display: none;
        }
        .invite-section.active {
            display: block;
        }
        .invite-search {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        .invite-search:focus {
            outline: none;
            border-color: #007bff;
        }
        .friends-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
        }
        .friend-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .friend-item:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }
        .friend-item.disabled {
            opacity: 0.6;
            background: #f8f9fa;
        }
        .friend-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            border: 2px solid #e0e0e0;
        }
        .friend-info {
            flex: 1;
        }
        .friend-name {
            font-weight: bold;
            margin-bottom: 3px;
            color: #333;
        }
        .friend-username {
            color: #666;
            font-size: 13px;
        }
        .member-badge {
            background: #6c757d;
            color: white;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 11px;
            margin-left: 8px;
        }
        .friend-select {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #007bff;
        }
        .friend-select:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .invite-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        .invite-counter {
            color: #666;
            font-size: 15px;
            font-weight: 500;
        }
        .invite-counter span {
            color: #007bff;
            font-weight: bold;
            font-size: 18px;
        }
        .invite-action-buttons {
            display: flex;
            gap: 10px;
        }
        .send-invite-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .send-invite-btn:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
        }
        .send-invite-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .cancel-btn {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .cancel-btn:hover {
            background: #5a6268;
        }
        .loading-spinner {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        .loading-spinner i {
            font-size: 40px;
            margin-bottom: 10px;
            color: #007bff;
        }
        .empty-friends {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .empty-friends i {
            font-size: 50px;
            color: #dee2e6;
            margin-bottom: 15px;
        }
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1100;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–∫—Ü–∏–∏ —Å—Å—ã–ª–∫–∏-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è */
        .invite-link-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .invite-link-label {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .invite-link-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .invite-link-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            background: white;
            color: #333;
        }
        .invite-link-input:focus {
            outline: none;
            border-color: #007bff;
        }
        .copy-link-btn {
            padding: 12px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .copy-link-btn:hover {
            background: #0056b3;
        }
        .invite-link-note {
            color: #666;
            font-size: 12px;
            margin-top: 10px;
        }
        .invite-link-note i {
            color: #ffc107;
            margin-right: 5px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='defaults/style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='uploads/favicon.png') }}">
</head>
<body>
    <div style="padding: 20px; max-width: 1000px; margin: 0 auto;">
        <h1>–ì—Ä—É–ø–ø—ã</h1>

        <div style="margin-bottom: 20px;">
            <a href="/home" style="margin-right: 10px;">‚Üê –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/profile" style="margin-right: 10px;">–ü—Ä–æ—Ñ–∏–ª—å</a>
        </div>

        <button class="create-group-btn" onclick="openCreateGroupModal()">
            + –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
        </button>

        <div class="search-bar">
            <form method="GET" action="/groups">
                <input type="text" name="search" placeholder="–ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø..." value="{{ search_query }}">
                <input type="hidden" name="tab" value="{{ current_tab }}">
            </form>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs">
            <a href="/groups?tab=all" class="tab {% if current_tab == 'all' %}active{% endif %}">–í—Å–µ –≥—Ä—É–ø–ø—ã</a>
            <a href="/groups?tab=my" class="tab {% if current_tab == 'my' %}active{% endif %}">–ú–æ–∏ –≥—Ä—É–ø–ø—ã</a>
        </div>

        {% if groups %}
        <div id="groups-container">
            {% for group in groups %}
            <div class="group-card">
                <a href="/group/{{ group.id }}">
                    <img src="{{ url_for('static', filename='uploads/groups/' + group.avatar) if group.avatar else 'https://via.placeholder.com/80?text=Group' }}"
                         class="group-avatar-large"
                         onerror="this.src='/static/defaults/for_groups.png'">
                </a>

                <div class="group-info">
                    <h2 style="margin-top: 0;">
                        <a href="/group/{{ group.id }}" class="group-name">
                            {{ group.name }}
                            {% if group.role %}
                                <span class="role-badge role-{{ group.role }}">
                                    {% if group.role == 'admin' %}
                                        –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                                    {% elif group.role == 'moderator' %}
                                        –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä
                                    {% else %}
                                        –£—á–∞—Å—Ç–Ω–∏–∫
                                    {% endif %}
                                </span>
                            {% endif %}
                        </a>
                    </h2>

                    <p style="color: #666; margin: 5px 0;">{{ group.description or '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è' }}</p>

                    <div class="group-stats">
                        <span>üë• {{ group.members_count }} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                        <span>üìù {{ group.posts_count }} –ø–æ—Å—Ç–æ–≤</span>
                        <span>üìÖ –°–æ–∑–¥–∞–Ω {{ group.created_at[:10] if group.created_at else '' }}</span>
                    </div>
                </div>

                <div class="group-actions">
                    {% if group.is_member %}
                        <form method="POST"
                              action="/leave_group/{{ group.id }}"
                              style="margin: 0;"
                              class="leave-group-form"
                              data-is-creator="{{ '1' if group.creator_id == session_user_id else '0' }}"
                              data-group-name="{{ group.name }}">
                            <button type="submit" class="unsubscribe-btn">
                                <i class="fas fa-sign-out-alt"></i> –û—Ç–ø–∏—Å–∞—Ç—å—Å—è
                            </button>
                        </form>
                        
                        <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ -->
                        {% if group.role == 'admin' %}
                        <button class="invite-btn" onclick="openInviteModal('{{ group.id }}', '{{ group.name|replace("'", "\\'")|replace('"', '&quot;')|safe }}')">
                            <i class="fas fa-user-plus"></i> –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å
                        </button>
                        <button class="invite-link-btn" onclick="openInviteLinkModal('{{ group.id }}', '{{ group.name|replace("'", "\\'")|replace('"', '&quot;')|safe }}')">
                            <i class="fas fa-link"></i> –°—Å—ã–ª–∫–∞
                        </button>
                        {% endif %}
                        
                    {% else %}
                        {% if group.has_pending_request %}
                        <div style="padding: 8px 16px; background: #fff3cd; color: #856404; border-radius: 4px; font-size: 14px; text-align: center;">
                            <i class="fas fa-hourglass-half"></i> –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞
                        </div>
                        {% else %}
                        <form method="POST" action="/join_group/{{ group.id }}">
                            <button type="submit" class="subscribe-btn">
                                <i class="fas fa-plus-circle"></i>
                                {% if group.is_public %}–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è{% else %}–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É{% endif %}
                            </button>
                        </form>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; color: #666;">
            <h3>
                {% if current_tab == 'my' %}
                    –£ –≤–∞—Å –Ω–µ—Ç –≥—Ä—É–ø–ø
                {% else %}
                    –ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                {% endif %}
            </h3>
            <p>
                {% if current_tab == 'my' %}
                    –í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∏ –Ω–∞ –æ–¥–Ω—É –≥—Ä—É–ø–ø—É. –ù–∞–π–¥–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –≥—Ä—É–ø–ø—ã –≤–æ –≤–∫–ª–∞–¥–∫–µ "–í—Å–µ –≥—Ä—É–ø–ø—ã" –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é!
                {% else %}
                    –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –≥—Ä—É–ø–ø—É –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
    <div id="createGroupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 500px; max-width: 90%;">
            <h2>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h2>
            <form method="POST" action="/create_group" enctype="multipart/form-data">
                <div style="margin-bottom: 15px;">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã *</label>
                    <input type="text" name="name" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="description" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; height: 100px;" placeholder="–û —á–µ–º —ç—Ç–∞ –≥—Ä—É–ø–ø–∞?"></textarea>
                </div>

                <div style="margin-bottom: 15px;">
                    <label>–ê–≤–∞—Ç–∞—Ä</label>
                    <input type="file" name="avatar" accept="image/*">
                </div>

                <div style="margin-bottom: 20px;">
                    <label>
                        <input type="checkbox" name="is_public" checked>
                        –ü—É–±–ª–∏—á–Ω–∞—è –≥—Ä—É–ø–ø–∞ (–≤–∏–¥–Ω–∞ –≤—Å–µ–º)
                    </label>
                </div>

                <div style="display: flex; justify-content: space-between;">
                    <button type="button" onclick="closeCreateGroupModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px;">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px;">
                        –°–æ–∑–¥–∞—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—É -->
    <div id="inviteModal" class="invite-modal">
        <div class="invite-modal-content">
            <div class="invite-modal-header">
                <h3><i class="fas fa-user-plus" style="margin-right: 10px; color: #17a2b8;"></i>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É <span id="inviteGroupName" style="color: #007bff;"></span></h3>
                <button class="invite-modal-close" onclick="closeInviteModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- –í–∫–ª–∞–¥–∫–∏ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
            <div class="invite-tabs">
                <button class="invite-tab active" onclick="switchInviteTab('friends')">–î—Ä—É–∑—å—è</button>
                <button class="invite-tab" onclick="switchInviteTab('link')">–°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</button>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è "–î—Ä—É–∑—å—è" -->
            <div id="inviteFriendsSection" class="invite-section active">
                <input type="text" 
                       class="invite-search" 
                       id="inviteSearch" 
                       placeholder="üîç –ü–æ–∏—Å–∫ –¥—Ä—É–∑–µ–π –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –ª–æ–≥–∏–Ω—É..."
                       onkeyup="filterFriends()">
                
                <div id="inviteFriendsList" class="friends-list">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π...</p>
                    </div>
                </div>
                
                <div class="invite-actions">
                    <div class="invite-counter">
                        –í—ã–±—Ä–∞–Ω–æ: <span id="inviteCounter">0</span>
                    </div>
                    <div class="invite-action-buttons">
                        <button class="send-invite-btn" onclick="sendInvitations()" id="sendInviteBtn" disabled>
                            <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
                        </button>
                        <button class="cancel-btn" onclick="closeInviteModal()">
                            <i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è "–°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ" -->
            <div id="inviteLinkSection" class="invite-section">
                <div class="invite-link-section">
                    <div class="invite-link-label">
                        <i class="fas fa-link" style="color: #007bff; margin-right: 5px;"></i>
                        –°—Å—ã–ª–∫–∞ –¥–ª—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—É
                    </div>
                    
                    <div class="invite-link-input-group">
                        <input type="text" 
                               id="inviteLinkInput" 
                               class="invite-link-input" 
                               readonly
                               value="–ó–∞–≥—Ä—É–∑–∫–∞...">
                        <button class="copy-link-btn" onclick="copyInviteLink()">
                            <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>
                    
                    <div class="invite-link-note">
                        <i class="fas fa-info-circle"></i>
                        –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º. –ü–æ –Ω–µ–π –æ–Ω–∏ —Å–º–æ–≥—É—Ç –≤—Å—Ç—É–ø–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è).
                    </div>
                    
                    <div class="invite-link-note" style="margin-top: 15px; color: #856404; background: #fff3cd; padding: 10px; border-radius: 5px;">
                        <i class="fas fa-shield-alt"></i>
                        <strong>–î–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –≥—Ä—É–ø–ø:</strong> —Å—Å—ã–ª–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –∑–∞—è–≤–∫–∞ ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –±—É–¥–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ.
                    </div>
                </div>
                
                <div class="invite-actions" style="justify-content: flex-end;">
                    <button class="cancel-btn" onclick="closeInviteModal()">
                        <i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
        let currentGroupId = null;
        let friendsList = [];
        let groupMemberIds = [];

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è (–≤–∫–ª–∞–¥–∫–∞ "–î—Ä—É–∑—å—è")
        function openInviteModal(groupId, groupName) {
            currentGroupId = groupId;
            document.getElementById('inviteGroupName').textContent = `"${groupName}"`;
            document.getElementById('inviteModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–î—Ä—É–∑—å—è"
            switchInviteTab('friends');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π
            loadFriends(groupId);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è (–≤–∫–ª–∞–¥–∫–∞ "–°—Å—ã–ª–∫–∞")
        function openInviteLinkModal(groupId, groupName) {
            currentGroupId = groupId;
            document.getElementById('inviteGroupName').textContent = `"${groupName}"`;
            document.getElementById('inviteModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–°—Å—ã–ª–∫–∞"
            switchInviteTab('link');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Å—ã–ª–∫—É-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
            loadInviteLink(groupId);
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').classList.remove('show');
            document.body.style.overflow = 'auto';
            currentGroupId = null;
            friendsList = [];
            groupMemberIds = [];
            document.getElementById('inviteSearch').value = '';
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
        function switchInviteTab(tabName) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.invite-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã —Å–µ–∫—Ü–∏–π
            document.querySelectorAll('.invite-section').forEach(section => {
                section.classList.remove('active');
            });
            
            if (tabName === 'friends') {
                document.getElementById('inviteFriendsSection').classList.add('active');
            } else {
                document.getElementById('inviteLinkSection').classList.add('active');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π
        function loadFriends(groupId) {
            const friendsListDiv = document.getElementById('inviteFriendsList');
            friendsListDiv.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π...</p></div>';
            
            fetch('/friends/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã
                        return fetch(`/group/${groupId}/members`)
                            .then(response => response.json())
                            .then(membersData => {
                                if (membersData.success) {
                                    groupMemberIds = membersData.member_ids;
                                }
                                return data;
                            });
                    }
                    return data;
                })
                .then(data => {
                    if (data.success) {
                        friendsList = data.friends;
                        displayFriends(friendsList);
                    } else {
                        friendsListDiv.innerHTML = '<div class="empty-friends"><i class="fas fa-exclamation-circle"></i><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π</p></div>';
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π:', error);
                    friendsListDiv.innerHTML = '<div class="empty-friends"><i class="fas fa-exclamation-circle"></i><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π</p></div>';
                });
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Å—ã–ª–∫–∏-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
        function loadInviteLink(groupId) {
            const linkInput = document.getElementById('inviteLinkInput');
            linkInput.value = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏...';
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É)
            // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π URL
            const baseUrl = window.location.origin;
            const inviteLink = `${baseUrl}/group/${groupId}`;
            linkInput.value = inviteLink;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π
        function displayFriends(friends) {
            const container = document.getElementById('inviteFriendsList');
            const searchTerm = document.getElementById('inviteSearch').value.toLowerCase();

            if (friends.length === 0) {
                container.innerHTML = '<div class="empty-friends"><i class="fas fa-user-friends"></i><p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</p><p style="font-size: 12px;">–î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–∑–µ–π –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü–æ–∏—Å–∫ –¥—Ä—É–∑–µ–π"</p></div>';
                return;
            }

            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–∏—Å–∫—É
            let filteredFriends = friends;
            if (searchTerm) {
                filteredFriends = friends.filter(friend => {
                    const username = friend.username.toLowerCase();
                    const fullName = (friend.full_name || '').toLowerCase();
                    return username.includes(searchTerm) || fullName.includes(searchTerm);
                });
            }

            if (filteredFriends.length === 0) {
                container.innerHTML = '<div class="empty-friends"><i class="fas fa-search"></i><p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p></div>';
                return;
            }

            container.innerHTML = '';

            filteredFriends.forEach(friend => {
                const isMember = groupMemberIds.includes(friend.id);
                const friendItem = document.createElement('div');
                friendItem.className = `friend-item ${isMember ? 'disabled' : ''}`;
                friendItem.dataset.username = friend.username;
                friendItem.dataset.fullname = friend.full_name || '';

                const avatarUrl = friend.avatar ? 
                    (friend.avatar.startsWith('http') ? friend.avatar : `/static/uploads/avatars/${friend.avatar}`) : 
                    '/static/defaults/for_users.png';

                friendItem.innerHTML = `
                    <img src="${avatarUrl}" 
                         class="friend-avatar"
                         onerror="this.src='/static/defaults/for_users.png'">
                    <div class="friend-info">
                        <div class="friend-name">
                            ${friend.full_name || friend.username}
                            ${isMember ? '<span class="member-badge">—É–∂–µ –≤ –≥—Ä—É–ø–ø–µ</span>' : ''}
                        </div>
                        <div class="friend-username">@${friend.username}</div>
                    </div>
                    ${!isMember ? 
                        `<input type="checkbox" class="friend-select" value="${friend.id}" onchange="updateInviteCounter()">` : 
                        '<span style="color:#999; font-size:12px; min-width:20px;"></span>'}
                `;

                container.appendChild(friendItem);
            });

            updateInviteCounter();
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π
        function filterFriends() {
            displayFriends(friendsList);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π
        function updateInviteCounter() {
            const selected = document.querySelectorAll('.friend-select:checked').length;
            document.getElementById('inviteCounter').textContent = selected;
            
            const sendBtn = document.getElementById('sendInviteBtn');
            if (selected > 0) {
                sendBtn.disabled = false;
                sendBtn.innerHTML = `<i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è (${selected})`;
            } else {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è';
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
        function sendInvitations() {
            const selectedFriends = Array.from(document.querySelectorAll('.friend-select:checked'))
                .map(cb => parseInt(cb.value));

            if (selectedFriends.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–∑–µ–π –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è');
                return;
            }

            if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è ${selectedFriends.length} –¥—Ä—É–≥(—É/–∑—å—è–º) –≤ –≥—Ä—É–ø–ø—É?`)) {
                return;
            }

            const sendBtn = document.getElementById('sendInviteBtn');
            const originalText = sendBtn.innerHTML;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';

            fetch(`/group/${currentGroupId}/invite`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ user_ids: selectedFriends })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessMessage(`–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã ${data.sent_count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º`);
                    
                    if (data.sent_ids) {
                        groupMemberIds = [...groupMemberIds, ...data.sent_ids];
                    }
                    
                    displayFriends(friendsList);
                    updateInviteCounter();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
            })
            .finally(() => {
                sendBtn.disabled = selectedFriends.length > 0;
                sendBtn.innerHTML = originalText;
            });
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
        function copyInviteLink() {
            const linkInput = document.getElementById('inviteLinkInput');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showSuccessMessage('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            } catch (err) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
            }
        }

        // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ
        function showSuccessMessage(message) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'success-message';
            msgDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(msgDiv);
            
            setTimeout(() => {
                msgDiv.remove();
            }, 3000);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã
        function openCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'block';
        }

        function closeCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.getElementById('createGroupModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCreateGroupModal();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
        document.getElementById('inviteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeInviteModal();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –Ω–∞–∂–∞—Ç–∏—é ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('inviteModal').classList.contains('show')) {
                    closeInviteModal();
                }
                if (document.getElementById('createGroupModal').style.display === 'block') {
                    closeCreateGroupModal();
                }
            }
        });

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ –≥—Ä—É–ø–ø—ã
        function confirmUnsubscribe(isCreator, groupName) {
            if (isCreator) {
                return confirm(`–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —è–≤–ª—è–µ—Ç–µ—Å—å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º –≥—Ä—É–ø–ø—ã "${groupName}".\n\n–ï—Å–ª–∏ –≤—ã –ø–æ–∫–∏–Ω–µ—Ç–µ –≥—Ä—É–ø–ø—É, –æ–Ω–∞ –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –£–î–ê–õ–ï–ù–ê –≤–º–µ—Å—Ç–µ —Å–æ –≤—Å–µ–º–∏ –ø–æ—Å—Ç–∞–º–∏, —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –∏ –¥–∞–Ω–Ω—ã–º–∏!\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?`);
            } else {
                return confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç –≥—Ä—É–ø–ø—ã "${groupName}"?`);
            }
        }

        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫ —Ñ–æ—Ä–º–∞–º —Å –∫–ª–∞—Å—Å–æ–º leave-group-form
        document.querySelectorAll('.leave-group-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                const isCreator = this.dataset.isCreator === '1';
                const groupName = this.dataset.groupName || '';
                if (!confirmUnsubscribe(isCreator, groupName)) {
                    e.preventDefault();
                }
            });
        });

        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ /
        document.addEventListener('keydown', function(e) {
            if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                e.preventDefault();
                const searchInput = document.querySelector('input[name="search"]');
                if (searchInput) searchInput.focus();
            }
        });
    </script>
</body>
</html>