<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π</title>
    <style>
        .post {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background: white;
        }
        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .group-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin-right: 10px;
        }
        .post-author {
            font-weight: bold;
        }
        .post-time {
            color: #666;
            font-size: 12px;
        }
        .post-content {
            margin: 10px 0;
        }
        .post-actions {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .post-actions button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .post-actions button:hover {
            color: #007bff;
        }
        .group-tag {
            display: inline-block;
            background: #e9f7fe;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }
        .create-post {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .create-post textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom: 2px solid #007bff;
            color: #007bff;
        }
        .groups-sidebar {
            position: fixed;
            right: 20px;
            top: 100px;
            width: 300px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
    </style>
</head>
<body>
    <div style="padding: 20px; max-width: 800px; margin: 0 auto;">
        <h1>–õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π</h1>

        <div style="margin-bottom: 20px;">
            <a href="/home" style="margin-right: 10px;">‚Üê –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/profile" style="margin-right: 10px;">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a>
            <a href="/groups" style="margin-right: 10px;">–ü–∞–±–ª–∏–∫–∏</a>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('all')">–í—Å–µ –ø–æ—Å—Ç—ã</div>
            <div class="tab" onclick="switchTab('friends')">–î—Ä—É–∑—å—è</div>
            <div class="tab" onclick="switchTab('groups')">–ü–∞–±–ª–∏–∫–∏</div>
        </div>

        <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞ -->
        <div class="create-post">
            <h3 style="margin-top: 0;">–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?</h3>
            <form method="POST" action="/create_post">
                <textarea name="content" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —á–µ–º-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º..." rows="3" required></textarea>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <select name="visibility" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="public">–î–ª—è –≤—Å–µ—Ö</option>
                        <option value="friends">–¢–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è–º</option>
                        <option value="private">–¢–æ–ª—å–∫–æ –º–Ω–µ</option>
                    </select>
                    <button type="submit" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px;">
                        –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                    </button>
                </div>
            </form>
        </div>

        <!-- –ü–æ—Å—Ç—ã -->
        <div id="posts-container">
            {% for post in posts %}
            <div class="post">
                <div class="post-header">
                    {% if post.group_id %}
                    <img src="{{ url_for('static', filename='uploads/groups/' + post.group_avatar) if post.group_avatar else 'https://via.placeholder.com/40?text=G' }}"
                         class="group-avatar"
                         onerror="this.src='https://via.placeholder.com/40?text=G'">
                    {% else %}
                    <img src="{{ url_for('static', filename='uploads/avatars/' + post.author_avatar) if post.author_avatar else 'https://via.placeholder.com/40?text=Avatar' }}"
                         class="post-avatar"
                         onerror="this.src='https://via.placeholder.com/40?text=Avatar'">
                    {% endif %}

                    <div>
                        <div class="post-author">
                            {% if post.group_id %}
                                <a href="/group/{{ post.group_id }}" style="color: inherit; text-decoration: none;">
                                    {{ post.group_name }}
                                </a>
                                <span class="group-tag">–ü–∞–±–ª–∏–∫</span>
                            {% else %}
                                <a href="/profile/{{ post.author_id }}" style="color: inherit; text-decoration: none;">
                                    {{ post.author_name or post.author_username }}
                                </a>
                            {% endif %}
                        </div>
                        <div class="post-time">
                            {{ datetime_format(post.created_at) }}
                            {% if post.group_id %}
                                ‚Ä¢ –ê–≤—Ç–æ—Ä: {{ post.author_name or post.author_username }}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="post-content">
                    {{ post.content|safe }}
                </div>

                <div class="post-actions">
                    <button onclick="likePost({{ post.id }})">
                        üëç {{ post.likes_count or 0 }}
                    </button>
                    <button onclick="commentPost({{ post.id }})">
                        üí¨ {{ post.comments_count or 0 }}
                    </button>
                    {% if post.author_id == session.user_id %}
                    <button onclick="deletePost({{ post.id }})" style="color: #dc3545;">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                    </button>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div style="text-align: center; padding: 40px; color: #666;">
                <h3>–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞</h3>
                <p>–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –ø–∞–±–ª–∏–∫–∏ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–∑–µ–π, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∏—Ö –ø–æ—Å—Ç—ã!</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –≥—Ä—É–ø–ø–∞–º–∏ -->
    <div class="groups-sidebar">
        <h3 style="margin-top: 0;">–í–∞—à–∏ –ø–∞–±–ª–∏–∫–∏</h3>
        {% for group in my_groups %}
        <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 10px; border-radius: 5px; background: #f8f9fa;">
            <img src="{{ url_for('static', filename='uploads/groups/' + group.avatar) if group.avatar else 'https://via.placeholder.com/30?text=G' }}"
                 style="width: 30px; height: 30px; border-radius: 5px; margin-right: 10px;"
                 onerror="this.src='https://via.placeholder.com/30?text=G'">
            <div style="flex: 1;">
                <strong><a href="/group/{{ group.id }}" style="color: inherit; text-decoration: none;">{{ group.name }}</a></strong>
                <div style="font-size: 12px; color: #666;">{{ group.members_count }} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
            </div>
        </div>
        {% endfor %}

        <div style="margin-top: 20px; text-align: center;">
            <a href="/groups" style="display: block; padding: 10px; background: #28a745; color: white; text-decoration: none; border-radius: 5px;">
                –ù–∞–π—Ç–∏ –ø–∞–±–ª–∏–∫–∏
            </a>
        </div>
    </div>

    <script>
        function switchTab(tab) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç AJAX –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
            fetch(`/feed/${tab}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('posts-container').innerHTML = html;
                });
        }

        function likePost(postId) {
            fetch(`/like_post/${postId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ª–∞–π–∫–æ–≤
                        const btn = event.target;
                        btn.innerHTML = `üëç ${data.likes_count}`;
                    }
                });
        }
    </script>
</body>
</html>